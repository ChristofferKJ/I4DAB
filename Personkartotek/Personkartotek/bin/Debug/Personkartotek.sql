/*
Deployment script for Personkartotek

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Personkartotek"
:setvar DefaultFilePrefix "Personkartotek"
:setvar DefaultDataPath "C:\Users\chris\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\chris\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The column [dbo].[Adresse].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Adresse])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[Emailadresse].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Emailadresse])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[Noter].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Noter])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[Operatoer].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Operatoer])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[Person].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Person])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[Telefon].[ID] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Telefon])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Dropping [dbo].[FKPerson_Adr332690]...';


GO
ALTER TABLE [dbo].[Person_Adresse] DROP CONSTRAINT [FKPerson_Adr332690];


GO
PRINT N'Dropping [dbo].[FRA]...';


GO
ALTER TABLE [dbo].[Adresse] DROP CONSTRAINT [FRA];


GO
PRINT N'Dropping [dbo].[FKEmailadres218851]...';


GO
ALTER TABLE [dbo].[Emailadresse] DROP CONSTRAINT [FKEmailadres218851];


GO
PRINT N'Dropping [dbo].[FKNoter584620]...';


GO
ALTER TABLE [dbo].[Noter] DROP CONSTRAINT [FKNoter584620];


GO
PRINT N'Dropping [dbo].[FKTelefon302512]...';


GO
ALTER TABLE [dbo].[Telefon] DROP CONSTRAINT [FKTelefon302512];


GO
PRINT N'Dropping [dbo].[FKPerson_Adr321172]...';


GO
ALTER TABLE [dbo].[Person_Adresse] DROP CONSTRAINT [FKPerson_Adr321172];


GO
PRINT N'Dropping [dbo].[FKTelefon747761]...';


GO
ALTER TABLE [dbo].[Telefon] DROP CONSTRAINT [FKTelefon747761];


GO
PRINT N'Starting rebuilding table [dbo].[Adresse]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Adresse] (
    [AdresseID]  INT           IDENTITY (1, 1) NOT NULL,
    [PersonID]   INT           NOT NULL,
    [Vej]        VARCHAR (255) NULL,
    [By]         VARCHAR (255) NULL,
    [Husnummer]  VARCHAR (255) NULL,
    [Postnummer] VARCHAR (255) NULL,
    PRIMARY KEY CLUSTERED ([AdresseID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Adresse])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Adresse] ([PersonID], [Vej], [By], [Husnummer], [Postnummer])
        SELECT [PersonID],
               [Vej],
               [By],
               [Husnummer],
               [Postnummer]
        FROM   [dbo].[Adresse];
    END

DROP TABLE [dbo].[Adresse];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Adresse]', N'Adresse';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Emailadresse]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Emailadresse] (
    [EmailID]  INT           IDENTITY (1, 1) NOT NULL,
    [PersonID] INT           NOT NULL,
    [Email]    VARCHAR (255) NULL,
    PRIMARY KEY CLUSTERED ([EmailID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Emailadresse])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Emailadresse] ([PersonID], [Email])
        SELECT [PersonID],
               [Email]
        FROM   [dbo].[Emailadresse];
    END

DROP TABLE [dbo].[Emailadresse];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Emailadresse]', N'Emailadresse';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Noter]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Noter] (
    [NoterID]  INT           IDENTITY (1, 1) NOT NULL,
    [Note]     VARCHAR (255) NULL,
    [PersonID] INT           NULL,
    PRIMARY KEY CLUSTERED ([NoterID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Noter])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Noter] ([Note], [PersonID])
        SELECT [Note],
               [PersonID]
        FROM   [dbo].[Noter];
    END

DROP TABLE [dbo].[Noter];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Noter]', N'Noter';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Operatoer]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Operatoer] (
    [OperatoerID] INT           IDENTITY (1, 1) NOT NULL,
    [Navn]        VARCHAR (255) NULL,
    PRIMARY KEY CLUSTERED ([OperatoerID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Operatoer])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Operatoer] ([Navn])
        SELECT [Navn]
        FROM   [dbo].[Operatoer];
    END

DROP TABLE [dbo].[Operatoer];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Operatoer]', N'Operatoer';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Person]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Person] (
    [PersonID] INT           IDENTITY (1, 1) NOT NULL,
    [Navn]     VARCHAR (255) NULL,
    [Type]     VARCHAR (255) NULL,
    PRIMARY KEY CLUSTERED ([PersonID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Person])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Person] ([Navn], [Type])
        SELECT [Navn],
               [Type]
        FROM   [dbo].[Person];
    END

DROP TABLE [dbo].[Person];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Person]', N'Person';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Telefon]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Telefon] (
    [TeleID]        INT           IDENTITY (1, 1) NOT NULL,
    [OperatoerID]   INT           NOT NULL,
    [PersonID]      INT           NOT NULL,
    [Telefonnummer] VARCHAR (255) NULL,
    PRIMARY KEY CLUSTERED ([TeleID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Telefon])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Telefon] ([OperatoerID], [PersonID], [Telefonnummer])
        SELECT [OperatoerID],
               [PersonID],
               [Telefonnummer]
        FROM   [dbo].[Telefon];
    END

DROP TABLE [dbo].[Telefon];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Telefon]', N'Telefon';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[FKPerson_Adr332690]...';


GO
ALTER TABLE [dbo].[Person_Adresse] WITH NOCHECK
    ADD CONSTRAINT [FKPerson_Adr332690] FOREIGN KEY ([AdresseID]) REFERENCES [dbo].[Adresse] ([AdresseID]);


GO
PRINT N'Creating [dbo].[FRA]...';


GO
ALTER TABLE [dbo].[Adresse] WITH NOCHECK
    ADD CONSTRAINT [FRA] FOREIGN KEY ([PersonID]) REFERENCES [dbo].[Person] ([PersonID]);


GO
PRINT N'Creating [dbo].[FKEmailadres218851]...';


GO
ALTER TABLE [dbo].[Emailadresse] WITH NOCHECK
    ADD CONSTRAINT [FKEmailadres218851] FOREIGN KEY ([PersonID]) REFERENCES [dbo].[Person] ([PersonID]);


GO
PRINT N'Creating [dbo].[FKNoter584620]...';


GO
ALTER TABLE [dbo].[Noter] WITH NOCHECK
    ADD CONSTRAINT [FKNoter584620] FOREIGN KEY ([PersonID]) REFERENCES [dbo].[Person] ([PersonID]);


GO
PRINT N'Creating [dbo].[FKTelefon302512]...';


GO
ALTER TABLE [dbo].[Telefon] WITH NOCHECK
    ADD CONSTRAINT [FKTelefon302512] FOREIGN KEY ([OperatoerID]) REFERENCES [dbo].[Operatoer] ([OperatoerID]);


GO
PRINT N'Creating [dbo].[FKPerson_Adr321172]...';


GO
ALTER TABLE [dbo].[Person_Adresse] WITH NOCHECK
    ADD CONSTRAINT [FKPerson_Adr321172] FOREIGN KEY ([PersonID]) REFERENCES [dbo].[Person] ([PersonID]);


GO
PRINT N'Creating [dbo].[FKTelefon747761]...';


GO
ALTER TABLE [dbo].[Telefon] WITH NOCHECK
    ADD CONSTRAINT [FKTelefon747761] FOREIGN KEY ([PersonID]) REFERENCES [dbo].[Person] ([PersonID]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Person_Adresse] WITH CHECK CHECK CONSTRAINT [FKPerson_Adr332690];

ALTER TABLE [dbo].[Adresse] WITH CHECK CHECK CONSTRAINT [FRA];

ALTER TABLE [dbo].[Emailadresse] WITH CHECK CHECK CONSTRAINT [FKEmailadres218851];

ALTER TABLE [dbo].[Noter] WITH CHECK CHECK CONSTRAINT [FKNoter584620];

ALTER TABLE [dbo].[Telefon] WITH CHECK CHECK CONSTRAINT [FKTelefon302512];

ALTER TABLE [dbo].[Person_Adresse] WITH CHECK CHECK CONSTRAINT [FKPerson_Adr321172];

ALTER TABLE [dbo].[Telefon] WITH CHECK CHECK CONSTRAINT [FKTelefon747761];


GO
PRINT N'Update complete.';


GO
